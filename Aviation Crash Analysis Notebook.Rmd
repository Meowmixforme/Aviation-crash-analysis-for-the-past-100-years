---
title: "Aviation Crash Analysis"
output: html_notebook
---

# Work in progress/ very messy/ needs sorting through and cleaning up as I complete parts

# Import data

```{r}
#install.packages("readr")
library(readr)
library(lubridate)

aero <- read.csv("Airplane_Crashes_and_Fatalities_Since_1908.csv")

```

```{r}
# First remove empty values or dashes and replace with NA

aero$Time <- ifelse(aero$Time == "", NA, aero$Time)
aero$Time <- ifelse(aero$Time == "-", NA, aero$Time)

#print(aero$Time[!is.na(aero$Time)])

non_conforming_values <- aero$Time[!grepl("^\\d{2}:\\d{2}$", aero$Time)]

#Print the non-conforming values
print(non_conforming_values[!is.na(non_conforming_values)])

```

We can see a few non conforming values, such as c: 1:00 12'20. Let's fix this first 


```{r}

aero$Time <- gsub("^c", "", aero$Time)  # Remove "c:" prefix
aero$Time <- gsub("'", ":", aero$Time) # Replace the apostrophe with a colon
aero$Time <- gsub("^:", "", aero$Time) # Remove leading colon
aero$Time <- trimws(aero$Time) # remove leading space
aero$Time <- sprintf("%02s",aero$Time) # add leading zero



# Show the problematic time values
#problematic_times <- aero$Time[!grepl("^\\d{2}:\\d{2}$", aero$Time)]

#print(problematic_times)

                     
#exact <- aero[grep("1:00", aero$Time), , drop = FALSE]  

#print(exact)

#non_conforming_values <- aero$Time[!grepl("^\\d{2}:\\d{2}$", aero$Time)]


#Print the non-conforming values
#print(non_conforming_values[!is.na(non_conforming_values)])


```

```{r}

# Refresh non_conforming_values

non_conforming_values <- aero$Time[!grepl("^\\d{2}:\\d{2}$", aero$Time)]

# We can see a few values still require fixing

unique(non_conforming_values)

```


```{r}

# Some values aren't fixed by adding leading zeros. Let's get their indexes and fix them manually

index_of_2_00 <- which(aero$Time == "2:00")
print(index_of_2_00)

index_of_1_00 <- which(aero$Time == "1:00")
print(index_of_1_00)

index_of_1_30 <- which(aero$Time == "1:30")
print(index_of_1_30)

index_of_18_40 <- which(aero$Time == "18.40")
print(index_of_18_40)

index_of_114_20 <- which(aero$Time == "114:20")
print(index_of_114_20)


```



```{r}

# Manually correct values without leading zeroes

new_value1 <- "02:00"
aero$Time[229] <- new_value1

new_value2 <- "02:00"
aero$Time[4849] <- new_value2

new_value3 <- "01:00"
aero$Time[191] <- new_value3

new_value4 <- "01:00"
aero$Time[3585] <- new_value4

new_value5 <- "01:30"
aero$Time[712] <- new_value5


```





# check data format

```{r}
str(aero)

```

Date needs to be changed
Time can be set into am/pm (time of day range) or other factor
all others except summary can be made into factors

```{r}
str(aero$Date)
str(aero$Time)
str(aero$Location)
str(aero$Operator)
str(aero$Route)
str(aero$type)
str(aero$Registration)
str(aero$cn.In)
str(aero$Aboard)
str(aero$Fatalities)
str(aero$Ground)
str(aero$Summary)

```

# Changing data types from Char and converting empty strings and dashes to NA

```{r}

aero <- aero %>%
  dplyr::mutate(Date = as.Date(Date, format="%m/%d/%Y")) 

  
  
# lubridate testing code (something to consider)

#aero$Date <- as.Date(aero$Date, format="%m/%d/%Y") # Change Date from a char to Date data type
#aero$Time <- lubridate::hm(aero$Time) # Change from char to lubridate

# Convert the Time column to POSIXct
#aero$Time <- strptime(aero$Time, format = "%H:%M")

# Extract hours and minutes as numeric
#aero$Time_numeric <- aero$Time$hour * 100 + aero$Time$min

# Changing all char to factors

#aero[sapply(aero, is.character)] <- lapply(aero[sapply(aero, is.character)], as.factor)

# Changing missing spaces and dashes into NA

aero$Location <- ifelse(aero$Location == "", NA, aero$Location)
aero$Operator <- ifelse(aero$Operator == "", NA, aero$Operator)
aero$Flight.. <- ifelse(aero$Flight.. == "", NA, aero$Flight..)
aero$Flight.. <- ifelse(aero$Flight.. == "-", NA, aero$Flight..)
aero$Route <- ifelse(aero$Route == "", NA, aero$Route)
aero$Type <- ifelse(aero$Type == "", NA, aero$Type)
aero$Registration <- ifelse(aero$Registration == "", NA, aero$Registration)
aero$cn.In <- ifelse(aero$cn.In == "", NA, aero$cn.In)
aero$Summary <- ifelse(aero$Summary == "", NA, aero$Summary)

```

# Percentage of missing values in each column

```{r}
#aero$Date[aero$Date == ""] <- NA # Fill in empty string with NA
#aero$Date[aero$Date == ""] <- NA # Fill in empty string with NA



#print(aero$Date)
#print(aero$Time)

misscol <- colSums(is.na(aero)) / nrow(aero)
round(misscol, 3)
```
Date has no missing values - perfect as a date format
Time needs changing next to categories
Fatalities has very few and can be quickly fixed first

```{r}
na_count1 <- sum(is.na(aero$Date))
na_count2 <- sum(is.na(aero$Time))
na_count3 <- sum(is.na(aero$Operator))
na_count4 <- sum(is.na(aero$Flight..))
na_count5 <- sum(is.na(aero$Route))
na_count6 <- sum(is.na(aero$Type))
na_count7 <- sum(is.na(aero$Registration))
na_count8 <- sum(is.na(aero$cn.In))
na_count9 <- sum(is.na(aero$Aboard))
na_count10 <- sum(is.na(aero$Fatalities))
na_count11 <- sum(is.na(aero$Ground))
na_count12 <- sum(is.na(aero$Summary))



na_count1
na_count2
na_count3
na_count4
na_count5
na_count6
na_count7
na_count8
na_count9
na_count10
na_count11
na_count12
```
# Search for most frequent words in Summary (Text Mining)

```{r}
library(tidytext)
library(dplyr)

aero <- as_tibble(aero)

# Tokenize and count words
word_counts <- aero %>%
  unnest_tokens(word, Summary) %>%  # This function splits the text into individual words.
  count(word, sort = TRUE)          # Count occurrences of each word

print(word_counts)
```

I'll need to get a list of words such as pilot = human error / engine = mechanical failure / thunderstorm/fog/weather = weather. Landing vs takeoff etc. Then make new columns with this extracted data.


```{r}
# need to sort out NA and make new columns from filtered words
```

```{r}
#cor(aero[sapply(aero, is.numeric)])

numeric_columns <- aero[sapply(aero, is.numeric)]
cor_matrix <- cor(numeric_columns, use = "complete.obs")
cor_matrix
```
Some quite obvious correlations (location/route) I'll need to clean the data up and try this properly later


```{r}
plot(aero)
```
Just a reminder that I'll need to visualise the data


Step 1 is dealing with missing data

```{r}

mean(aero$Fatalities, na.rm = TRUE)

# 20.0683 is the mean

max(aero$Fatalities, na.rm = TRUE)

# 583 is the max value

min(aero$Fatalities, na.rm = TRUE)

# 0 is the lowest value (no one died in the crash)

```
# missForest

```{r}

# I'll try imputation with missForest as we have such a huge range and see if it impacts the mean

library(missForest)

library(missForest)
imputed_single_column <- missForest(data.frame(aero$Fatalities))

```

